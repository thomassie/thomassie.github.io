---
title: Storm data preparation
author: Thomas M. Massie
date: 1/8/2018
output:
  html_document:
    keep_md: true
published: true
---



## Loading the data

I downloaded the data sets from NOAA's [National Hurricane Center](http://www.nhc.noaa.gov/data/#hurdat), one for hurricanes and one for typhoons, and stored them in my respective GitHub repository. Data format is the revised Atlantic hurricane database (HURDAT2, see [here](http://www.aoml.noaa.gov/hrd/hurdat/Data_Storm.html) for details).  

Now, to start I will load both data sets from my repository, and add a variable that indicates the respective ocean it belongs to.

```r
dd.atlantic <- read_csv("https://raw.githubusercontent.com/thomassie/Storms/master/Data/atlantic.csv?token=AFYWCm0CTFVvcnJCMs2F3z0u0Ce_ditGks5aXIiEwA%3D%3D") %>%
  mutate(Ocean = "atlantic")
dd.pacific  <- read_csv("https://raw.githubusercontent.com/thomassie/Storms/master/Data/pacific.csv?token=AFYWCuigbUpPM8d8V93uIzgYr-aat70Eks5aXIlcwA%3D%3D") %>%
  mutate(Ocean = "pacific")
```

This is what the original Atlantic data looks like:

```
## Classes 'tbl_df', 'tbl' and 'data.frame':	49105 obs. of  23 variables:
##  $ ID              : chr  "AL011851" "AL011851" "AL011851" "AL011851" ...
##  $ Name            : chr  "UNNAMED" "UNNAMED" "UNNAMED" "UNNAMED" ...
##  $ Date            : int  18510625 18510625 18510625 18510625 18510625 18510626 18510626 18510626 18510626 18510627 ...
##  $ Time            : int  0 600 1200 1800 2100 0 600 1200 1800 0 ...
##  $ Event           : chr  NA NA NA NA ...
##  $ Status          : chr  "HU" "HU" "HU" "HU" ...
##  $ Latitude        : chr  "28.0N" "28.0N" "28.0N" "28.1N" ...
##  $ Longitude       : chr  "94.8W" "95.4W" "96.0W" "96.5W" ...
##  $ Maximum Wind    : int  80 80 80 80 80 70 60 60 50 50 ...
##  $ Minimum Pressure: int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Low Wind NE     : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Low Wind SE     : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Low Wind SW     : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Low Wind NW     : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Moderate Wind NE: int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Moderate Wind SE: int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Moderate Wind SW: int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Moderate Wind NW: int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ High Wind NE    : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ High Wind SE    : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ High Wind SW    : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ High Wind NW    : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Ocean           : chr  "atlantic" "atlantic" "atlantic" "atlantic" ...
```

...and the data from the Pacific:

```
## Classes 'tbl_df', 'tbl' and 'data.frame':	26137 obs. of  23 variables:
##  $ ID              : chr  "EP011949" "EP011949" "EP011949" "EP011949" ...
##  $ Name            : chr  "UNNAMED" "UNNAMED" "UNNAMED" "UNNAMED" ...
##  $ Date            : int  19490611 19490611 19490611 19490611 19490612 19490612 19490612 19490617 19490617 19490618 ...
##  $ Time            : int  0 600 1200 1800 0 600 1200 1200 1800 0 ...
##  $ Event           : chr  NA NA NA NA ...
##  $ Status          : chr  "TS" "TS" "TS" "TS" ...
##  $ Latitude        : chr  "20.2N" "20.2N" "20.2N" "20.3N" ...
##  $ Longitude       : chr  "106.3W" "106.4W" "106.7W" "107.7W" ...
##  $ Maximum Wind    : int  45 45 45 45 45 45 45 45 45 45 ...
##  $ Minimum Pressure: int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Low Wind NE     : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Low Wind SE     : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Low Wind SW     : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Low Wind NW     : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Moderate Wind NE: int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Moderate Wind SE: int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Moderate Wind SW: int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Moderate Wind NW: int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ High Wind NE    : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ High Wind SE    : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ High Wind SW    : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ High Wind NW    : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Ocean           : chr  "pacific" "pacific" "pacific" "pacific" ...
```

I combine both data sets to a single one, and remove spaces in variable names by '.'.

```r
dd.org <- bind_rows(dd.atlantic, dd.pacific)
names(dd.org) <- make.names(names(dd.org), unique=TRUE)
str(dd.org)
```

```
## Classes 'tbl_df', 'tbl' and 'data.frame':	75242 obs. of  23 variables:
##  $ ID              : chr  "AL011851" "AL011851" "AL011851" "AL011851" ...
##  $ Name            : chr  "UNNAMED" "UNNAMED" "UNNAMED" "UNNAMED" ...
##  $ Date            : int  18510625 18510625 18510625 18510625 18510625 18510626 18510626 18510626 18510626 18510627 ...
##  $ Time            : int  0 600 1200 1800 2100 0 600 1200 1800 0 ...
##  $ Event           : chr  NA NA NA NA ...
##  $ Status          : chr  "HU" "HU" "HU" "HU" ...
##  $ Latitude        : chr  "28.0N" "28.0N" "28.0N" "28.1N" ...
##  $ Longitude       : chr  "94.8W" "95.4W" "96.0W" "96.5W" ...
##  $ Maximum.Wind    : int  80 80 80 80 80 70 60 60 50 50 ...
##  $ Minimum.Pressure: int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Low.Wind.NE     : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Low.Wind.SE     : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Low.Wind.SW     : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Low.Wind.NW     : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Moderate.Wind.NE: int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Moderate.Wind.SE: int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Moderate.Wind.SW: int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Moderate.Wind.NW: int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ High.Wind.NE    : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ High.Wind.SE    : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ High.Wind.SW    : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ High.Wind.NW    : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Ocean           : chr  "atlantic" "atlantic" "atlantic" "atlantic" ...
```



## Data wrangling

Next, I make some adjustments but leave the original variables as they were (for comparison):

- One important step is making new date, time, and datetime variables.
- Also, wind speed is converted into the metric system (km per hour).
- Further, I included a variable named 'Duration' which will come into play at a latter point when the duration of a storm is calculated.
- And last, there are some inconsistencies in the data: Generally, when there is no data available for pressure cells were filled with '-999'. However, sometimes it is '-99' or odd entries. To make it homogeneous and to avoid trouble when using the values in calculation, I changed all these entries to 'NA'.

```r
dd <- dd.org %>%
  mutate(Date.new = as.Date(as.character(Date), "%Y%m%d")) %>%
  mutate(Time.new = times(sub("(.{2})", "\\1:", sprintf("%04d:00", Time)))) %>%
  # mutate(DateTime.new = with(dd.org, as.POSIXct(paste(Date.new, Time.new)))) %>%
  mutate(DateTime.new = with(dd.org, as.POSIXct(paste(Date.new, Time.new)))) %>%
  mutate(Year = year(DateTime.new)) %>%
  mutate(DateTime.sameyear = as.POSIXct(strptime(format(DateTime.new, "%m/%d %H:%M:%S"), "%m/%d %H:%M:%S"))) %>%
  mutate(Maximum.Wind.kph = round(Maximum.Wind * 1.609344, 0)) %>%
  mutate(ID.plus = paste(Name, " (",ID,")", sep = "")) %>%
  mutate(Duration = NA) %>%   # Needed at a latter point.
  # For some storms there's no data about wind speeds.
  # Hence, these are removed here.
  filter(Maximum.Wind >= 0) %>%
  mutate(Minimum.Pressure = ifelse(Minimum.Pressure > 500, Minimum.Pressure, NA))
# mutate(Minimum.Pressure = ifelse(Minimum.Pressure > 500, Minimum.Pressure, -999))
```

Then, for some variables it makes more sense if they are declared as factors.

```r
dd[c("ID",
     "Year",
     "ID.plus",
     "Status",
     "Ocean")] = lapply(dd[c("ID",
                             "Year",
                             "ID.plus",
                             "Status",
                             "Ocean")], as.factor)
```


For plotting reasons, entries referring to the position of a storm at a given time have to be transferred into a format that is easier to handle, i.e. numeric. For example, '28.0N' is becoming '28', and '94.8W' is transferred into '265.2'. Westward and southward values are getting a negative sign, just like in an cartesian system. However, due to the fact that mapping is often far easier with positive values, both, 360 (degrees) is added to westward and eastward values. Hope that is comprehensible.

```r
dd$Latitude[which(grepl("N", dd$Latitude)==TRUE)] <- as.numeric(gsub("N", "", dd$Latitude[which(grepl("N", dd$Latitude)==TRUE)]))
dd$Latitude[which(grepl("S", dd$Latitude)==TRUE)] <- -as.numeric(gsub("S", "", dd$Latitude[which(grepl("S", dd$Latitude)==TRUE)]))
dd$Longitude[which(grepl("W", dd$Longitude)==TRUE)] <- -as.numeric(gsub("W", "", dd$Longitude[which(grepl("W", dd$Longitude)==TRUE)])) + 360
dd$Longitude[which(grepl("E", dd$Longitude)==TRUE)] <- as.numeric(gsub("E", "", dd$Longitude[which(grepl("E", dd$Longitude)==TRUE)])) + 360
# Make both columns numeric.
dd$Latitude <- as.numeric(dd$Latitude)
dd$Longitude <- as.numeric(dd$Longitude)
```


Finally, as announced previously, the duration of a storm is calculated.

```r
# ids <- as.character(unique(dd$ID))
for (i in as.character(unique(dd$ID))) {
  dd.i <- filter(dd, ID == i)
  for (n in 1:length(dd.i$ID)) {
    # '%--%' is the interval operator returning the time difference (lubridate).
    dd.i$Duration[n] <- as.numeric(as.duration(dd.i$DateTime.new[1] %--% dd.i$DateTime.new[n]))/60/60/24
  }
  dd$Duration[which(dd$ID %in% i)] <- dd.i$Duration
}
```

There you go!

```
## Classes 'tbl_df', 'tbl' and 'data.frame':	74904 obs. of  31 variables:
##  $ ID               : Factor w/ 2845 levels "AL011851","AL011852",..: 1 1 1 1 1 1 1 1 1 1 ...
##  $ Name             : chr  "UNNAMED" "UNNAMED" "UNNAMED" "UNNAMED" ...
##  $ Date             : int  18510625 18510625 18510625 18510625 18510625 18510626 18510626 18510626 18510626 18510627 ...
##  $ Time             : int  0 600 1200 1800 2100 0 600 1200 1800 0 ...
##  $ Event            : chr  NA NA NA NA ...
##  $ Status           : Factor w/ 12 levels "DB","ET","EX",..: 4 4 4 4 4 4 11 11 11 11 ...
##  $ Latitude         : num  28 28 28 28.1 28.2 28.2 28.3 28.4 28.6 29 ...
##  $ Longitude        : num  265 265 264 264 263 ...
##  $ Maximum.Wind     : int  80 80 80 80 80 70 60 60 50 50 ...
##  $ Minimum.Pressure : int  NA NA NA NA NA NA NA NA NA NA ...
##  $ Low.Wind.NE      : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Low.Wind.SE      : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Low.Wind.SW      : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Low.Wind.NW      : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Moderate.Wind.NE : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Moderate.Wind.SE : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Moderate.Wind.SW : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Moderate.Wind.NW : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ High.Wind.NE     : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ High.Wind.SE     : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ High.Wind.SW     : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ High.Wind.NW     : int  -999 -999 -999 -999 -999 -999 -999 -999 -999 -999 ...
##  $ Ocean            : Factor w/ 2 levels "atlantic","pacific": 1 1 1 1 1 1 1 1 1 1 ...
##  $ Date.new         : Date, format: "1851-06-25" "1851-06-25" ...
##  $ Time.new         :Class 'times'  atomic [1:74904] 0 0.25 0.5 0.75 0.875 0 0.25 0.5 0.75 0 ...
##   .. ..- attr(*, "format")= chr "h:m:s"
##  $ DateTime.new     : POSIXct, format: "1851-06-25 00:00:00" "1851-06-25 06:00:00" ...
##  $ Year             : Factor w/ 165 levels "1851","1852",..: 1 1 1 1 1 1 1 1 1 1 ...
##  $ DateTime.sameyear: POSIXct, format: "2018-06-25 00:00:00" "2018-06-25 06:00:00" ...
##  $ Maximum.Wind.kph : num  129 129 129 129 129 113 97 97 80 80 ...
##  $ ID.plus          : Factor w/ 2845 levels "ABBY (AL011968)",..: 1562 1562 1562 1562 1562 1562 1562 1562 1562 1562 ...
##  $ Duration         : num  0 0.25 0.5 0.75 0.875 1 1.25 1.5 1.75 2 ...
```



## Storing the dataset

I am going to save the workspace and the dataset for later use and exploration!

```r
save.image("Data/StormWS.RData")
write.csv(dd, file = "Data/StormDataset.csv")
```
